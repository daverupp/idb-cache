{"version":3,"file":"idb-cache.js","sources":["idb-cache.js"],"sourcesContent":["/**\n * @author Drecom Co.,Ltd. http://www.drecom.co.jp/\n */\nconst VERSION = 1;\nconst STORE_NAME = {\n    META: 'metastore',\n    DATA: 'datastore',\n};\nconst DATA_TYPE = {\n    STRING: 1,\n    ARRAYBUFFER: 2,\n    BLOB: 3,\n};\n// iPhone/iPod/iPad\nconst isIOS = /iP(hone|(o|a)d);/.test(window.navigator.userAgent);\nexport default class IDBCache {\n    constructor(dbName, strageLimit) {\n        this._maxSize = 52428800; // 50MB\n        this._maxCount = 100; // 100files\n        this._defaultAge = 86400; // 1day\n        this._nowSize = 0;\n        this._metaCache = new Map();\n        this._indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.OIndexedDB || window.msIndexedDB;\n        this._dbName = dbName;\n        if (!this._indexedDB) {\n            console.error('IndexedDB is not supported');\n            return;\n        }\n        if (strageLimit) {\n            if (strageLimit.size)\n                this._maxSize = strageLimit.size;\n            if (strageLimit.count)\n                this._maxCount = strageLimit.count;\n            if (strageLimit.defaultAge)\n                this._defaultAge = strageLimit.defaultAge;\n        }\n        this._initialize();\n    }\n    /**\n     * Save key-value in IndexedDB.\n     * Overwrite if the key already exists.\n     * @param key\n     * @param value\n     * @param maxAge Number of seconds to keep\n     */\n    set(key, value, maxAge = this._defaultAge) {\n        return new Promise((resolve, reject) => {\n            this._serializeData(value, (data, meta) => {\n                if (meta.size === 0) {\n                    reject(IDBCache.ERROR.INVALID_ARGUMENT);\n                    return;\n                }\n                this._open((db) => {\n                    const transaction = db.transaction([STORE_NAME.META, STORE_NAME.DATA], 'readwrite');\n                    const metaStore = transaction.objectStore(STORE_NAME.META);\n                    const dataStore = transaction.objectStore(STORE_NAME.DATA);\n                    const nowSeconds = Math.floor(Date.now() / 1000);\n                    meta.expire = nowSeconds + maxAge;\n                    transaction.oncomplete = () => {\n                        transaction.oncomplete = null;\n                        transaction.onerror = null;\n                        transaction.onabort = null;\n                        const cacheMeta = this._metaCache.get(key);\n                        if (cacheMeta) {\n                            this._metaCache.delete(key);\n                            this._nowSize -= cacheMeta.size;\n                        }\n                        this._metaCache.set(key, meta);\n                        this._nowSize += meta.size;\n                        if (this._maxCount < this._metaCache.size || this._maxSize < this._nowSize) {\n                            this._cleanup();\n                        }\n                        resolve();\n                    };\n                    transaction.onerror = () => {\n                        transaction.oncomplete = null;\n                        transaction.onerror = null;\n                        transaction.onabort = null;\n                        reject(IDBCache.ERROR.REQUEST_FAILED);\n                    };\n                    transaction.onabort = () => {\n                        transaction.oncomplete = null;\n                        transaction.onerror = null;\n                        transaction.onabort = null;\n                        reject(IDBCache.ERROR.REQUEST_FAILED);\n                    };\n                    try {\n                        dataStore.put(data, key);\n                        metaStore.put(meta, key);\n                    }\n                    catch (e) {\n                        console.error(e);\n                        transaction.abort();\n                    }\n                }, (errorCode) => {\n                    // Open error\n                    reject(errorCode);\n                });\n            });\n        });\n    }\n    /**\n     * Get value from IndexedDB\n     * @param key\n     */\n    get(key) {\n        return new Promise((resolve, reject) => {\n            this._open((db) => {\n                const transaction = db.transaction(STORE_NAME.DATA, 'readonly');\n                const dataStore = transaction.objectStore(STORE_NAME.DATA);\n                const request = dataStore.get(key);\n                request.onsuccess = () => {\n                    request.onsuccess = null;\n                    request.onerror = null;\n                    const nowSeconds = Math.floor(Date.now() / 1000);\n                    const cacheMeta = this._metaCache.get(key);\n                    if (request.result && cacheMeta && nowSeconds < cacheMeta.expire) {\n                        this._deserializeData(request.result, cacheMeta, (data) => {\n                            resolve(data);\n                        });\n                    }\n                    else {\n                        // Can not find or expired\n                        reject(IDBCache.ERROR.GET_EMPTY);\n                    }\n                };\n                request.onerror = () => {\n                    request.onsuccess = null;\n                    request.onerror = null;\n                    reject(IDBCache.ERROR.REQUEST_FAILED);\n                };\n            }, (errorCode) => {\n                // Open error\n                reject(errorCode);\n            });\n        });\n    }\n    /**\n     * Delete one value of IndexedDB\n     * @param key\n     */\n    delete(key) {\n        return new Promise((resolve, reject) => {\n            this._open((db) => {\n                const transaction = db.transaction([STORE_NAME.META, STORE_NAME.DATA], 'readwrite');\n                const metaStore = transaction.objectStore(STORE_NAME.META);\n                const dataStore = transaction.objectStore(STORE_NAME.DATA);\n                transaction.oncomplete = () => {\n                    transaction.oncomplete = null;\n                    transaction.onerror = null;\n                    transaction.onabort = null;\n                    const cacheMeta = this._metaCache.get(key);\n                    if (cacheMeta) {\n                        this._metaCache.delete(key);\n                        this._nowSize -= cacheMeta.size;\n                    }\n                    resolve();\n                };\n                transaction.onerror = () => {\n                    transaction.oncomplete = null;\n                    transaction.onerror = null;\n                    transaction.onabort = null;\n                    reject(IDBCache.ERROR.REQUEST_FAILED);\n                };\n                transaction.onabort = () => {\n                    transaction.oncomplete = null;\n                    transaction.onerror = null;\n                    transaction.onabort = null;\n                    reject(IDBCache.ERROR.REQUEST_FAILED);\n                };\n                try {\n                    dataStore.delete(key);\n                    metaStore.delete(key);\n                }\n                catch (e) {\n                    console.error(e);\n                    transaction.abort();\n                }\n            }, (errorCode) => {\n                // Open error\n                reject(errorCode);\n            });\n        });\n    }\n    _initialize() {\n        this._open((db) => {\n            const transaction = db.transaction(STORE_NAME.META, 'readonly');\n            const metaStore = transaction.objectStore(STORE_NAME.META);\n            this._metaCache.clear();\n            this._nowSize = 0;\n            transaction.oncomplete = () => {\n                transaction.oncomplete = null;\n                transaction.onerror = null;\n                // Sort in ascending order of expire\n                const sortArray = [];\n                const itelator = this._metaCache.entries();\n                let iteratorResult = itelator.next();\n                while (!iteratorResult.done) {\n                    sortArray.push(iteratorResult.value);\n                    iteratorResult = itelator.next();\n                }\n                sortArray.sort(function (a, b) {\n                    if (a[1].expire < b[1].expire)\n                        return -1;\n                    if (a[1].expire > b[1].expire)\n                        return 1;\n                    return 0;\n                });\n                this._metaCache = new Map(sortArray);\n                this._cleanup();\n            };\n            transaction.onerror = () => {\n                transaction.oncomplete = null;\n                transaction.onerror = null;\n            };\n            metaStore.openCursor().onsuccess = (event) => {\n                const cursor = event.target.result;\n                if (cursor) {\n                    this._metaCache.set(cursor.key, cursor.value);\n                    this._nowSize += cursor.value.size;\n                    cursor.continue();\n                }\n                ;\n            };\n        }, () => {\n            // Ignore open error\n        });\n    }\n    _cleanup() {\n        this._open((db) => {\n            const removeKeys = new Set();\n            const nowSeconds = Math.floor(Date.now() / 1000);\n            let tmpNowCount = this._metaCache.size;\n            this._metaCache.forEach((meta, key) => {\n                if (meta.expire < nowSeconds || this._maxSize < this._nowSize || this._maxCount < tmpNowCount) {\n                    removeKeys.add(key);\n                    this._nowSize -= meta.size;\n                    tmpNowCount--;\n                }\n            });\n            if (0 < removeKeys.size) {\n                const transaction = db.transaction([STORE_NAME.META, STORE_NAME.DATA], 'readwrite');\n                const metaStore = transaction.objectStore(STORE_NAME.META);\n                const dataStore = transaction.objectStore(STORE_NAME.DATA);\n                transaction.oncomplete = () => {\n                    transaction.oncomplete = null;\n                    transaction.onerror = null;\n                    transaction.onabort = null;\n                    removeKeys.forEach((key) => {\n                        if (this._metaCache.has(key))\n                            this._metaCache.delete(key);\n                    });\n                };\n                transaction.onerror = () => {\n                    console.error('IndexedDB cleanup failed');\n                    transaction.oncomplete = null;\n                    transaction.onerror = null;\n                    transaction.onabort = null;\n                    this._nowSize = 0;\n                    this._metaCache.forEach((meta) => {\n                        this._nowSize += meta.size;\n                    });\n                };\n                transaction.onabort = () => {\n                    console.error('IndexedDB cleanup failed');\n                    transaction.oncomplete = null;\n                    transaction.onerror = null;\n                    transaction.onabort = null;\n                    this._nowSize = 0;\n                    this._metaCache.forEach((meta) => {\n                        this._nowSize += meta.size;\n                    });\n                };\n                removeKeys.forEach((key) => {\n                    try {\n                        dataStore.delete(key);\n                        metaStore.delete(key);\n                    }\n                    catch (e) {\n                        transaction.abort();\n                    }\n                });\n            }\n        }, () => {\n            // Ignore open error\n        });\n    }\n    _createObjectStore(db, oldVersion) {\n        if (oldVersion < 1) {\n            // Structure of first edition\n            db.createObjectStore(STORE_NAME.META);\n            db.createObjectStore(STORE_NAME.DATA);\n        }\n    }\n    _open(success, error) {\n        if (!this._indexedDB) {\n            error(IDBCache.ERROR.NOT_SUPPORT_IDB);\n            return;\n        }\n        let request = this._indexedDB.open(this._dbName, VERSION);\n        request.onupgradeneeded = (event) => {\n            request.onupgradeneeded = null;\n            this._createObjectStore(request.result, event.oldVersion);\n        };\n        request.onblocked = () => {\n            request.onblocked = null;\n            alert('Please close other tabs');\n        };\n        request.onsuccess = () => {\n            request.onupgradeneeded = null;\n            request.onblocked = null;\n            request.onsuccess = null;\n            request.onerror = null;\n            try {\n                success(request.result);\n            }\n            catch (e) {\n                console.error(e);\n                error(IDBCache.ERROR.UNKNOWN);\n            }\n        };\n        request.onerror = () => {\n            console.error('IndexedDB open failed');\n            request.onupgradeneeded = null;\n            request.onblocked = null;\n            request.onsuccess = null;\n            request.onerror = null;\n            error(IDBCache.ERROR.CANNOT_OPEN);\n        };\n    }\n    _serializeData(data, cb) {\n        const meta = {\n            type: 0,\n            size: 0,\n        };\n        if (typeof data === 'string') {\n            meta.type = DATA_TYPE.STRING;\n            meta.size = data.length;\n        }\n        else if (data instanceof ArrayBuffer) {\n            meta.type = DATA_TYPE.ARRAYBUFFER;\n            meta.size = data.byteLength;\n        }\n        else if (data instanceof Blob) {\n            meta.type = DATA_TYPE.BLOB;\n            meta.size = data.size;\n        }\n        else {\n            console.warn('Is not supported type of value');\n        }\n        // IndexedDB on iOS does not support blob\n        if (isIOS && meta.type === DATA_TYPE.BLOB) {\n            const reader = new FileReader();\n            reader.onload = () => {\n                reader.onload = null;\n                meta.size = reader.result.byteLength;\n                meta.mime = data.type;\n                cb(reader.result, meta);\n            };\n            reader.onerror = () => {\n                reader.onerror = null;\n                meta.size = 0;\n                cb(null, meta);\n            };\n            reader.readAsArrayBuffer(data);\n        }\n        else {\n            cb(data, meta);\n        }\n    }\n    _deserializeData(data, meta, cb) {\n        let type = 0;\n        if (typeof data === 'string') {\n            type = DATA_TYPE.STRING;\n        }\n        else if (data instanceof ArrayBuffer) {\n            type = DATA_TYPE.ARRAYBUFFER;\n        }\n        else if (data instanceof Blob) {\n            type = DATA_TYPE.BLOB;\n        }\n        if (meta && meta.type === DATA_TYPE.BLOB && type === DATA_TYPE.ARRAYBUFFER) {\n            const blob = new Blob([data], { type: meta.mime });\n            cb(blob);\n        }\n        else {\n            cb(data);\n        }\n    }\n}\nIDBCache.ERROR = {\n    INVALID_ARGUMENT: 1,\n    CANNOT_OPEN: 2,\n    REQUEST_FAILED: 3,\n    GET_EMPTY: 4,\n    NOT_SUPPORT_IDB: 5,\n    UNKNOWN: 6,\n};\n"],"names":["VERSION","STORE_NAME","META","DATA","DATA_TYPE","STRING","ARRAYBUFFER","BLOB","isIOS","test","window","navigator","userAgent","IDBCache","dbName","strageLimit","_maxSize","_maxCount","_defaultAge","_nowSize","_metaCache","Map","_indexedDB","indexedDB","webkitIndexedDB","mozIndexedDB","OIndexedDB","msIndexedDB","_dbName","console","error","size","count","defaultAge","_initialize","key","value","maxAge","Promise","resolve","reject","_serializeData","data","meta","ERROR","INVALID_ARGUMENT","_open","db","transaction","metaStore","objectStore","dataStore","nowSeconds","Math","floor","Date","now","expire","oncomplete","onerror","onabort","cacheMeta","get","delete","set","_cleanup","REQUEST_FAILED","put","e","abort","errorCode","request","onsuccess","result","_deserializeData","GET_EMPTY","clear","sortArray","itelator","entries","iteratorResult","next","done","push","sort","a","b","openCursor","event","cursor","target","continue","removeKeys","Set","tmpNowCount","forEach","add","has","oldVersion","createObjectStore","success","NOT_SUPPORT_IDB","open","onupgradeneeded","_createObjectStore","onblocked","alert","UNKNOWN","CANNOT_OPEN","cb","type","length","ArrayBuffer","byteLength","Blob","warn","reader","FileReader","onload","mime","readAsArrayBuffer","blob"],"mappings":"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"}
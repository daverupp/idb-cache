// idb-cache - https://github.com/drecom/idb-cache
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.IDBCache=n()}(this,function(){"use strict";var o=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},e=function(){function t(e,n){for(var o=0;o<n.length;o++){var t=n[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),_="metastore",p="datastore",r=1,a=2,i=3,l=/iP(hone|(o|a)d);/.test(window.navigator.userAgent),n=function(){function d(e,n){o(this,d),this._maxSize=52428800,this._maxCount=100,this._defaultAge=86400,this._nowSize=0,this._metaCache=new Map,this._indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB,this._dbName=e,this._indexedDB?(n&&(n.size&&(this._maxSize=n.size),n.count&&(this._maxCount=n.count),n.defaultAge&&(this._defaultAge=n.defaultAge)),this._initialize()):console.error("IndexedDB is not supported")}return e(d,[{key:"set",value:function(c,e){var s=this,f=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this._defaultAge;return new Promise(function(l,u){s._serializeData(e,function(a,i){0!==i.size?s._open(function(e){var n=e.transaction([_,p],"readwrite"),o=n.objectStore(_),t=n.objectStore(p),r=Math.floor(Date.now()/1e3);i.expire=r+f,n.oncomplete=function(){n.oncomplete=null,n.onerror=null,n.onabort=null;var e=s._metaCache.get(c);e&&(s._metaCache.delete(c),s._nowSize-=e.size),s._metaCache.set(c,i),s._nowSize+=i.size,(s._maxCount<s._metaCache.size||s._maxSize<s._nowSize)&&s._cleanup(),l()},n.onerror=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,u(d.ERROR.REQUEST_FAILED)},n.onabort=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,u(d.ERROR.REQUEST_FAILED)};try{t.put(a,c),o.put(i,c)}catch(e){console.error(e),n.abort()}},function(){u(d.ERROR.CANNOT_OPEN)}):u(d.ERROR.INVALID_ARGUMENT)})})}},{key:"get",value:function(a){var i=this;return new Promise(function(t,r){i._open(function(e){var o=e.transaction(p,"readonly").objectStore(p).get(a);o.onsuccess=function(){o.onsuccess=null,o.onerror=null;var e=Math.floor(Date.now()/1e3),n=i._metaCache.get(a);o.result&&n&&e<n.expire?i._deserializeData(o.result,n,function(e){t(e)}):r(d.ERROR.GET_EMPTY)},o.onerror=function(){o.onsuccess=null,o.onerror=null,r(d.ERROR.REQUEST_FAILED)}},function(){r(d.ERROR.CANNOT_OPEN)})})}},{key:"delete",value:function(i){var l=this;return new Promise(function(r,a){l._open(function(e){var n=e.transaction([_,p],"readwrite"),o=n.objectStore(_),t=n.objectStore(p);n.oncomplete=function(){n.oncomplete=null,n.onerror=null,n.onabort=null;var e=l._metaCache.get(i);e&&(l._metaCache.delete(i),l._nowSize-=e.size),r()},n.onerror=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,a(d.ERROR.REQUEST_FAILED)},n.onabort=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,a(d.ERROR.REQUEST_FAILED)};try{t.delete(i),o.delete(i)}catch(e){console.error(e),n.abort()}},function(){a(d.ERROR.CANNOT_OPEN)})})}},{key:"_initialize",value:function(){var r=this;this._open(function(e){var t=e.transaction(_,"readonly"),n=t.objectStore(_);r._metaCache.clear(),r._nowSize=0,t.oncomplete=function(){t.oncomplete=null,t.onerror=null;for(var e=[],n=r._metaCache.entries(),o=n.next();!o.done;)e.push(o.value),o=n.next();e.sort(function(e,n){return e[1].expire<n[1].expire?-1:e[1].expire>n[1].expire?1:0}),r._metaCache=new Map(e),r._cleanup()},t.onerror=function(){t.oncomplete=null,t.onerror=null},n.openCursor().onsuccess=function(e){var n=e.target.result;n&&(r._metaCache.set(n.key,n.value),r._nowSize+=n.value.size,n.continue())}},function(){})}},{key:"_cleanup",value:function(){var l=this;this._open(function(e){var o=new Set,t=Math.floor(Date.now()/1e3),r=l._metaCache.size;if(l._metaCache.forEach(function(e,n){(e.expire<t||l._maxSize<l._nowSize||l._maxCount<r)&&(o.add(n),l._nowSize-=e.size,r--)}),0<o.size){var n=e.transaction([_,p],"readwrite"),a=n.objectStore(_),i=n.objectStore(p);n.oncomplete=function(){n.oncomplete=null,n.onerror=null,n.onabort=null,o.forEach(function(e){l._metaCache.has(e)&&l._metaCache.delete(e)})},n.onerror=function(){console.error("IndexedDB cleanup failed"),n.oncomplete=null,n.onerror=null,n.onabort=null,l._nowSize=0,l._metaCache.forEach(function(e){l._nowSize+=e.size})},n.onabort=function(){console.error("IndexedDB cleanup failed"),n.oncomplete=null,n.onerror=null,n.onabort=null,l._nowSize=0,l._metaCache.forEach(function(e){l._nowSize+=e.size})},o.forEach(function(e){try{i.delete(e),a.delete(e)}catch(e){n.abort()}})}},function(){})}},{key:"_createObjectStore",value:function(e,n){n<1&&(e.createObjectStore(_),e.createObjectStore(p))}},{key:"_open",value:function(e,n){var o=this;if(this._indexedDB){var t=this._indexedDB.open(this._dbName,1);t.onupgradeneeded=function(e){t.onupgradeneeded=null,o._createObjectStore(t.result,e.oldVersion)},t.onblocked=function(){t.onblocked=null,alert("Please close other tabs")},t.onsuccess=function(){t.onupgradeneeded=null,t.onblocked=null,t.onsuccess=null,t.onerror=null,e(t.result)},t.onerror=function(){console.error("IndexedDB open failed"),t.onupgradeneeded=null,t.onblocked=null,t.onsuccess=null,t.onerror=null,n()}}else n()}},{key:"_serializeData",value:function(e,n){var o={type:0,size:0};if("string"==typeof e?(o.type=r,o.size=e.length):e instanceof ArrayBuffer?(o.type=a,o.size=e.byteLength):e instanceof Blob?(o.type=i,o.size=e.size):console.warn("Is not supported type of value"),l&&o.type===i){var t=new FileReader;t.onload=function(){t.onload=null,o.size=t.result.byteLength,o.mime=e.type,n(t.result,o)},t.onerror=function(){t.onerror=null,o.size=0,n(null,o)},t.readAsArrayBuffer(e)}else n(e,o)}},{key:"_deserializeData",value:function(e,n,o){var t=0;("string"==typeof e?t=r:e instanceof ArrayBuffer?t=a:e instanceof Blob&&(t=i),n&&n.type===i&&t===a)?o(new Blob([e],{type:n.mime})):o(e)}}]),d}();return n.ERROR={INVALID_ARGUMENT:1,CANNOT_OPEN:2,REQUEST_FAILED:3,GET_EMPTY:4},n});
// idb-cache - https://github.com/drecom/idb-cache
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.IDBCache=t()}(this,function(){"use strict";var o=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}(),d="metastore",h="datastore",r=/iP(hone|(o|a)d);/.test(navigator.userAgent);return function(){function n(e,t){o(this,n),this._maxSize=52428800,this._maxCount=100,this._defaultAge=86400,this._nowSize=0,this._metaCache=new Map,this._indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB,this._dbName=e,t&&(t.size&&(this._maxSize=t.size),t.count&&(this._maxCount=t.count),t.defaultAge&&(this._defaultAge=t.defaultAge)),this._initialize()}return e(n,[{key:"set",value:function(l,e){var s=this,f=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this._defaultAge;return new Promise(function(c,u){s._serializeData(e,function(a,i){0!==i.size?s._open(function(e){var n=e.transaction([d,h],"readwrite"),t=n.objectStore(d),o=n.objectStore(h),r=Math.floor(Date.now()/1e3);i.expire=r+f,n.oncomplete=function(e){n.oncomplete=null;var t=s._metaCache.get(l);t&&(s._nowSize-=t.size,s._metaCache.delete(l)),s._nowSize+=i.size,s._metaCache.set(l,i),(s._maxCount<s._metaCache.size||s._maxSize<s._nowSize)&&s._cleanup(),c()},n.onerror=function(e){n.onerror=null,u()},n.onabort=function(e){n.onabort=null,u()};try{o.put(a,l),t.put(i,l)}catch(e){console.error(e),n.abort()}}):u()})})}},{key:"get",value:function(i){var c=this;return new Promise(function(r,a){c._open(function(e){var o=e.transaction(h,"readonly").objectStore(h).get(i);o.onsuccess=function(e){var t=Math.floor(Date.now()/1e3),n=c._metaCache.get(i);o.result&&n&&t<n.expire?c._deserializeData(o.result,n,function(e){r(e)}):a()},o.onerror=function(e){a()}},function(){a()})})}},{key:"delete",value:function(i){var c=this;return new Promise(function(r,a){c._open(function(e){var t=e.transaction([d,h],"readwrite"),n=t.objectStore(d),o=t.objectStore(h);t.oncomplete=function(e){t.oncomplete=null,c._metaCache.has(i)&&c._metaCache.delete(i),r()},t.onerror=function(e){t.onerror=null,a()},t.onabort=function(e){t.onabort=null,a()};try{o.delete(i),n.delete(i)}catch(e){console.error(e),t.abort()}},function(){a()})})}},{key:"_initialize",value:function(){var o=this;this._open(function(e){var t=e.transaction(d,"readonly"),n=t.objectStore(d);o._metaCache.clear(),o._nowSize=0,n.openCursor().onsuccess=function(e){var t=e.target.result;t&&(o._metaCache.set(t.key,t.value),o._nowSize+=t.value.size,t.continue())},t.oncomplete=function(){t.oncomplete=null,o._metaCache=new Map([].concat(function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(o._metaCache.entries())).sort(function(e,t){return e[1].expire<t[1].expire?-1:e[1].expire>t[1].expire?1:0})),o._cleanup()}})}},{key:"_cleanup",value:function(){var u=this;this._open(function(e){var n=new Set,o=Math.floor(Date.now()/1e3),r=u._nowSize,a=u._metaCache.size;if(u._metaCache.forEach(function(e,t){(e.expire<o||u._maxSize<r||u._maxCount<a)&&(n.add(t),r-=e.size,a--)}),0<n.size){var t=e.transaction([d,h],"readwrite"),i=t.objectStore(d),c=t.objectStore(h);t.oncomplete=function(e){t.oncomplete=null,n.forEach(function(e){u._metaCache.has(e)&&u._metaCache.delete(e)})},n.forEach(function(e){try{c.delete(e),i.delete(e)}catch(e){t.abort()}})}})}},{key:"_createObjectStore",value:function(e,t){t<1&&(e.createObjectStore(d),e.createObjectStore(h))}},{key:"_open",value:function(t,n){var o=this,r=this._indexedDB.open(this._dbName,1);r.onupgradeneeded=function(e){r.onupgradeneeded=null,o._createObjectStore(r.result,e.oldVersion)},r.onsuccess=function(e){r.onsuccess=null,t(r.result)},r.onerror=function(e){r.onerror=null,n&&n()}}},{key:"_serializeData",value:function(e,t){var n={type:0,size:0};if("string"==typeof e?(n.type=1,n.size=e.length):e instanceof ArrayBuffer?(n.type=2,n.size=e.byteLength):e instanceof Blob?(n.type=3,n.size=e.size):console.warn("Is not supported type of value"),r&&3===n.type){var o=new FileReader;o.onload=function(){o.onload=null,n.size=o.result.byteLength,n.mime=e.type,t(o.result,n)},o.onerror=function(){o.onerror=null,n.size=0,t(null,n)},o.readAsArrayBuffer(e)}else t(e,n)}},{key:"_deserializeData",value:function(e,t,n){var o=0;("string"==typeof e?o=1:e instanceof ArrayBuffer?o=2:e instanceof Blob&&(o=3),t&&3===t.type&&2===o)?n(new Blob([e],{type:t.mime})):n(e)}}]),n}()});
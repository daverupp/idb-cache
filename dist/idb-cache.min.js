// idb-cache - https://github.com/drecom/idb-cache
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.IDBCache=t()}(this,function(){"use strict";var o=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}(),d="metastore",h="datastore",a=/iP(hone|(o|a)d);/.test(navigator.userAgent);return function(){function n(e,t){o(this,n),this._maxSize=52428800,this._maxCount=100,this._defaultAge=86400,this._nowSize=0,this._metaCache=new Map,this._indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB,this._dbName=e,t&&(t.size&&(this._maxSize=t.size),t.count&&(this._maxCount=t.count),t.defaultAge&&(this._defaultAge=t.defaultAge)),this._initialize()}return e(n,[{key:"set",value:function(s,e){var l=this,f=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this._defaultAge;return new Promise(function(c,u){l._serializeData(e,function(a,i){0!==i.size?l._open(function(e){var n=e.transaction([d,h],"readwrite"),t=n.objectStore(d),o=n.objectStore(h),r=Math.floor(Date.now()/1e3);i.expire=r+f,n.oncomplete=function(e){n.oncomplete=null;var t=l._metaCache.get(s);t&&(l._nowSize-=t.size,l._metaCache.delete(s)),l._nowSize+=i.size,l._metaCache.set(s,i),(l._maxCount<l._metaCache.size||l._maxSize<l._nowSize)&&l._cleanup(),c()},n.onerror=function(e){n.onerror=null,u()},n.onabort=function(e){n.onabort=null,u()};try{o.put(a,s),t.put(i,s)}catch(e){console.error(e),n.abort()}}):c()})})}},{key:"get",value:function(a){var i=this;return new Promise(function(r,t){i._open(function(e){var o=e.transaction(h,"readonly").objectStore(h).get(a);o.onsuccess=function(e){var t=Math.floor(Date.now()/1e3),n=i._metaCache.get(a);o.result&&n&&t<n.expire?i._deserializeData(o.result,n,function(e){r(e)}):r(void 0)},o.onerror=function(e){t()}},function(){t()})})}},{key:"delete",value:function(i){var c=this;return new Promise(function(r,a){c._open(function(e){var t=e.transaction([d,h],"readwrite"),n=t.objectStore(d),o=t.objectStore(h);t.oncomplete=function(e){t.oncomplete=null,c._metaCache.has(i)&&c._metaCache.delete(i),r()},t.onerror=function(e){t.onerror=null,a()},t.onabort=function(e){t.onabort=null,a()};try{o.delete(i),n.delete(i)}catch(e){console.error(e),t.abort()}},function(){a()})})}},{key:"_initialize",value:function(){var r=this;this._open(function(e){var t=Date.now();console.warn("GET CACHE START");var n=e.transaction(d,"readonly"),o=n.objectStore(d);r._metaCache.clear(),r._nowSize=0,o.openCursor().onsuccess=function(e){console.warn("GET CACHE");var t=e.target.result;t&&(r._metaCache.set(t.key,t.value),r._nowSize+=t.value.size,t.continue())},n.oncomplete=function(){console.warn("GET CACHE COMP:"+(Date.now()-t)),n.oncomplete=null,r._metaCache=new Map([].concat(function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(r._metaCache.entries())).sort(function(e,t){return e[1].expire<t[1].expire?-1:e[1].expire>t[1].expire?1:0})),console.warn("SORT COMP:"+(Date.now()-t)),r._cleanup()}})}},{key:"_cleanup",value:function(){var u=this;this._open(function(e){var n=new Set,o=Math.floor(Date.now()/1e3),r=u._nowSize,a=u._metaCache.size;if(u._metaCache.forEach(function(e,t){(e.expire<o||u._maxSize<r||u._maxCount<a)&&(n.add(t),r-=e.size,a--)}),0<n.size){var t=e.transaction([d,h],"readwrite"),i=t.objectStore(d),c=t.objectStore(h);t.oncomplete=function(e){t.oncomplete=null,n.forEach(function(e){u._metaCache.has(e)&&u._metaCache.delete(e)})},n.forEach(function(e){try{c.delete(e),i.delete(e)}catch(e){t.abort()}})}})}},{key:"_createObjectStore",value:function(e,t){t<1&&(e.createObjectStore(d),e.createObjectStore(h))}},{key:"_open",value:function(t,n){var o=this,r=this._indexedDB.open(this._dbName,1);r.onupgradeneeded=function(e){r.onupgradeneeded=null,o._createObjectStore(r.result,e.oldVersion)},r.onsuccess=function(e){r.onsuccess=null,t(r.result)},r.onerror=function(e){r.onerror=null,n&&n()}}},{key:"_serializeData",value:function(t,n){var o={type:0,size:0};if("string"==typeof t?(o.type=1,o.size=t.length):t instanceof ArrayBuffer?(o.type=2,o.size=t.byteLength):t instanceof Blob?(o.type=3,o.size=t.size):console.warn("Unsupported type value"),a&&3===o.type){var r=new FileReader;r.onload=function(e){o.size=r.result.byteLength,o.mime=t.type,n(r.result,o)},r.onerror=function(e){o.size=0,n(null,o)},r.readAsArrayBuffer(t)}else n(t,o)}},{key:"_deserializeData",value:function(e,t,n){var o=0;("string"==typeof e?o=1:e instanceof ArrayBuffer?o=2:e instanceof Blob&&(o=3),t&&3===t.type&&2===o)?n(new Blob([e],{type:t.mime})):n(e)}}]),n}()});